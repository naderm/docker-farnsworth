#!/bin/bash
set -e

cat > /etc/httpd/conf.d/vhost.conf <<EOF
WSGISocketPrefix run/wsgi

<VirtualHost *:80>
     ServerAdmin ${HOUSE_ABBREV}nm@bsc.coop
     ServerName ${URL}
     ServerAlias www.${URL}
     ErrorLog logs/error_log
     CustomLog logs/access_log combined
EOF

# Redirect port 80 to 443 and enable ssl
if [ -n "$ENABLE_SSL" ] ; then
    cat >> /etc/httpd/conf.d/vhost.conf <<EOF
     Redirect permanent / https://${URL}/
</VirtualHost>

<VirtualHost *:443>
     ServerAdmin ${HOUSE_ABBREV}nm@bsc.coop
     ServerName ${URL}
     ServerAlias www.${URL}
     ErrorLog logs/error_log
     CustomLog logs/access_log combined

     SSLEngine on
     SSLCertificateFile /etc/pki/tls/certs/${URL}.crt
     SSLCertificateKeyFile /etc/pki/tls/private/${URL}.key
     SSLCertificateChainFile /etc/pki/tls/certs/sub.class1.server.ca.pem

     WSGIDaemonProcess ${URL}
     WSGIProcessGroup ${URL}
     WSGIScriptAlias / /var/www/farnsworth/farnsworth/wsgi.py
     Alias /static/ /var/www/farnsworth/static/
EOF
fi

# Close the vhost tag
cat >> /etc/httpd/conf.d/vhost.conf <<EOF
</VirtualHost>
EOF

cd /var/www/farnsworth

cat > farnsworth/house_settings.py <<EOF
SECRET_KEY = "$(openssl rand -base64 48)"
HOUSE_NAME = "${HOUSE_NAME}"
SHORT_HOUSE_NAME = "${SHORT_HOUSE_NAME}"
HOUSE_ABBREV = "${HOUSE_ABBREV}"
SITE_DOMAIN = "${URL}"
POSTGRES_PASSWORD = "${POSTGRESQL_PASS}"
EOF

./manage.py collectstatic --noinput > /dev/null
./manage.py syncdb --noinput
./manage.py test
#./manage.py migrate

farnsworth/pre_fill.py

chown -R apache:apache .

/usr/sbin/apachectl -D FOREGROUND
